version: '3.8'
services:
  mariadb:
    image: mariadb
    build:
      context: ./requirements/mariadb
      dockerfile: Dockerfile
    environment:
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/db_password.txt
      - TZ=Africa/Casablanca
    volumes:
      - mariadb_v:/var/lib/mysql
      - ../secrets/db_password.txt:/run/secrets/db_password.txt:ro
    networks:
      - inception
  
  php-wordpress:
    image: php-wordpress
    build:
      context: ./requirements/wordpress
      dockerfile: Dockerfile
    volumes:
      - wordpress_v:/var/www/html/wp-content
      - ../secrets/db_password.txt:/run/secrets/db_password.txt:ro
      - ./requirements/nginx/conf/ssl/certs/wordpress.crt:/etc/ssl/certs/wordpress.crt:ro
      - ./requirements/nginx/conf/ssl/private/wordpress.key:/etc/ssl/private/wordpress.key:ro
    environment:
      - WORDPRESS_DB_HOST=mariadb:3306
      - WORDPRESS_DB_NAME=mariadb
      - WORDPRESS_DB_USER=root
      - WORDPRESS_DB_PASSWORD_FILE=/run/secrets/db_password.txt
    networks:
      - inception
  
  nginx:
    image: nginx
    build:
      context: ./requirements/nginx
      dockerfile: Dockerfile
    volumes:
      - ./requirements/nginx/conf/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./requirements/nginx/conf/ssl/certs/wordpress.crt:/etc/ssl/certs/wordpress.crt:ro	
      - ./requirements/nginx/conf/ssl/private/wordpress.key:/etc/ssl/private/wordpress.key:ro
      - wordpress_v:/usr/share/nginx/html:ro
    networks:
      - inception
    ports:
      - "443:443"
volumes:
  mariadb_v:
  wordpress_v:
networks:
  inception:
